<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
  />
  <meta name="theme-color" content="#0b1220" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Mafia (Single-file, Dark, Mobile)</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b1220;
      --card: #111827;
      --muted: #9aa4b2;
      --text: #e5e7eb;
      --line: #1f2937;
      --accent: #22d3ee;
      --accent-2: #8b5cf6;
      --error: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;
      --btn: #1f2937;
      --btn-hover: #273449;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #0b1220, #0b1220 70%, #0a0f1a);
      color: var(--text);
      font: 16px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      padding: calc(10px + env(safe-area-inset-top)) 12px calc(16px + env(safe-area-inset-bottom));
    }
    .app { max-width: 820px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; padding: 8px 0 12px; }
    .brand { display: inline-flex; align-items: center; gap: 10px; }
    .logo {
      width: 28px; height: 28px; border-radius: 8px;
      background: radial-gradient(80% 80% at 20% 20%, #0ea5e9, #1d4ed8 60%, #0b1220 100%);
      box-shadow: 0 0 0 2px #0ea5e933 inset, 0 0 24px #0ea5e955;
    }
    h1 { font-size: 18px; margin: 0; letter-spacing: .4px; }
    .sub { color: var(--muted); font-size: 12px; }

    .card { background: var(--card); border: 1px solid var(--line); border-radius: 14px; padding: 12px; box-shadow: 0 10px 30px #0004; }
    .grid { display: grid; gap: 10px; }
    .row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .row > * { min-width: 0; }
    .grow { flex: 1; }
    .stack { display: grid; gap: 8px; }
    .footerBar { position: sticky; bottom: 0; left: 0; right: 0; padding-top: 12px; backdrop-filter: blur(6px); }

    input[type="text"] { width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid var(--line); background: #0b1220; color: var(--text); outline: none; }
    input[type="range"] { width: 100%; accent-color: var(--accent); }

    .btn { background: var(--btn); color: var(--text); border: 1px solid var(--line); border-radius: 12px; padding: 12px 14px; cursor: pointer; font-weight: 700; }
    .btn:hover { background: var(--btn-hover); }
    .btn.primary { background: linear-gradient(180deg, #0ea5e9, #2563eb); border-color: #0ea5e955; box-shadow: 0 6px 24px #2563eb55; }
    .btn.accent  { background: linear-gradient(180deg, #22d3ee, #0ea5e9); border-color: #22d3ee66; }
    .btn.warn    { background: linear-gradient(180deg, #f59e0b, #ea580c); border-color: #f59e0b66; }
    .btn.success { background: linear-gradient(180deg, #22c55e, #16a34a); border-color: #22c55e66; }
    .btn.ghost { background: #0b1220; border-color: var(--line); }

    .pill { padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); color: var(--muted); }
    .pill.red { background: #7f1d1d; color: #fecaca; border-color: #b91c1c; }
    .pill.green { background: #052e1a; color: #bbf7d0; border-color: #065f46; }
    .pill.blue { background: #0b1220; color: #bae6fd; border-color: #0ea5e9; }
    .hint { color: var(--muted); font-size: 13px; }
    .title { font-weight: 800; font-size: 18px; letter-spacing: .3px; }

    .screen { display: none; }
    .screen.active { display: block; }

    .list { list-style: none; padding: 0; margin: 0; }
    .player { display: flex; align-items: center; gap: 10px; padding: 10px 6px; border-bottom: 1px solid var(--line); }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: #475569; }
    .dead .name { color: #475569; text-decoration: line-through; }
    .roleBadge { padding: 4px 8px; border-radius: 999px; font-size: 12px; border: 1px solid var(--line); }
    .roleBadge.mafia { background: #3f1d2b; color: #fecaca; border-color: #ef4444; }
    .roleBadge.civ { background: #052e1a; color: #bbf7d0; border-color: #22c55e; }

    .voteGrid { display: grid; gap: 8px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .voteBtn { display: flex; gap: 8px; align-items: center; padding: 12px; border-radius: 12px; border: 1px solid var(--line); background: #0b1220; color: var(--text); cursor: pointer; text-align: left; }
    .voteBtn.selected { outline: 2px solid var(--accent); background: #0b1428; }
    .voteBtn.disabled { opacity: .45; cursor: not-allowed; filter: saturate(.5); }

    .toast { position: fixed; bottom: calc(20px + env(safe-area-inset-bottom)); left: 50%; transform: translateX(-50%); background: #0f172a; color: var(--text); border: 1px solid var(--line); border-radius: 12px; padding: 10px 12px; box-shadow: 0 10px 30px #0008; z-index: 3; display: none; }
    .toast.show { display: block; animation: fade .2s ease-out; }
    @keyframes fade { from { opacity: 0; transform: translate(-50%, 10px);} to { opacity: 1; transform: translate(-50%, 0);} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo"></div>
        <div>
          <h1>Mafia</h1>
          <div id="subtitle" class="sub">Dark mode • Single file</div>
        </div>
      </div>
      <div class="row" style="gap:6px">
        <span id="roomTag" class="pill blue" style="display:none"></span>
        <span id="meTag" class="pill" style="display:none"></span>
      </div>
    </header>

    <!-- Join Screen -->
    <section id="screen-join" class="screen active">
      <div class="card grid">
        <div class="title">Join or Create a Room</div>
        <div class="row">
          <input id="nameInput" type="text" placeholder="Your name" />
        </div>
        <div class="row">
          <input id="codeInput" type="text" placeholder="Room code (e.g. 4F2K9Q)" style="text-transform: uppercase" />
        </div>
        <div class="row">
          <button id="createBtn" class="btn primary grow">Create Room</button>
          <button id="joinBtn" class="btn grow">Join Room</button>
        </div>
        <div class="row"><span class="hint">Share the 6-letter room code with your friends.</span></div>
      </div>
    </section>

    <!-- Role Screen (core gameplay) -->
    <section id="screen-role" class="screen">
      <div class="card grid" style="text-align:center">
        <div class="title">Your Role</div>

        <div id="roleMasked" class="pill" style="margin: 8px auto; font-size:14px; display:none">Hidden • Tap Show</div>
        <div id="roleBadge" class="pill" style="margin: 8px auto; font-size:14px"></div>

        <div class="row" style="justify-content:center; gap:10px">
          <div class="pill">Alive: <strong id="aliveCounter">0</strong></div>
          <div class="pill">Mafia left: <strong id="mafiaCounter">0</strong></div>
          <div id="roundPill" class="pill">Round: <strong id="roundNo">1</strong></div>
        </div>

        <div class="row" style="justify-content:center; gap:10px">
          <button id="toggleRoleBtn" class="btn ghost" style="min-width:140px">Hide Role</button>
          <button id="startGameBtn" class="btn accent" style="min-width:160px; display:none">Start Game</button>
          <button id="startMeetingBtn" class="btn warn" style="min-width:160px; display:none">Start Meeting</button>
        </div>

        <!-- Meeting/Vote panel appears under role -->
        <div id="votePanel" class="card" style="display:none; text-align:left">
          <div class="row" style="align-items:center">
            <div class="title grow" id="voteTitle">Voting</div>
            <span id="votePhaseBadge" class="pill blue">Voting</span>
          </div>
          <div id="voteHint" class="hint">Choose one player. No skips.</div>
          <div id="voteGrid" class="voteGrid" style="margin-top:8px"></div>
          <div class="row footerBar">
            <button id="submitVoteBtn" class="btn success grow" disabled>Submit Vote</button>
          </div>
          <div class="sub" id="voteStatus" style="margin-top:6px"></div>
        </div>

        <!-- Ejection panel -->
        <div id="ejectPanel" class="card" style="display:none">
          <div class="title" id="ejectTitle">Ejection</div>
          <div id="ejectDetail" class="hint"></div>
        </div>
      </div>
    </section>

    <div id="toast" class="toast"></div>
  </div>

  <script type="module">
    // Firebase (No-Auth Test Mode). Your RTDB URL:
    const firebaseConfig = { databaseURL: "https://testgame-e98b8-default-rtdb.asia-southeast1.firebasedatabase.app/" };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, set, update, onValue, runTransaction, get } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // Initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Elements
    const screenJoin = byId("screen-join");
    const screenRole = byId("screen-role");
    const meTag = byId("meTag");
    const roomTag = byId("roomTag");
    const subtitle = byId("subtitle");
    const nameInput = byId("nameInput");
    const codeInput = byId("codeInput");
    const createBtn = byId("createBtn");
    const joinBtn = byId("joinBtn");
    const roleBadge = byId("roleBadge");
    const roleMasked = byId("roleMasked");
    const toggleRoleBtn = byId("toggleRoleBtn");
    const startGameBtn = byId("startGameBtn");
    const startMeetingBtn = byId("startMeetingBtn");
    const aliveCounter = byId("aliveCounter");
    const mafiaCounter = byId("mafiaCounter");
    const roundNo = byId("roundNo");

    const votePanel = byId("votePanel");
    const voteTitle = byId("voteTitle");
    const votePhaseBadge = byId("votePhaseBadge");
    const voteHint = byId("voteHint");
    const voteGrid = byId("voteGrid");
    const submitVoteBtn = byId("submitVoteBtn");
    const voteStatus = byId("voteStatus");

    const ejectPanel = byId("ejectPanel");
    const ejectTitle = byId("ejectTitle");
    const ejectDetail = byId("ejectDetail");
    const toastEl = byId("toast");

    // State
    const uid = getOrMakeGuestId();
    meTag.style.display = "inline-block";
    meTag.textContent = `You: ${uid.slice(0,6)}…`;

    let roomCode = "";
    let myName = "";
    let isHost = false;
    let roomSnap = null;
    let myRoleIsMafia = null;
    let roleHidden = true; // local toggle
    let selectedVote = null;
    let unsubRoom = null;

    // PRNG + Weighted mafia selection
    function mulberry32(seed){return function(){let t=(seed+=0x6d2b79f5);t=Math.imul(t^(t>>>15),t|1);t^=t+Math.imul(t^(t>>>7),t|61);return((t^(t>>>14))>>>0)/4294967296;}}
    function normalizeSeed(seedStr){if(!seedStr||!seedStr.trim())return Math.floor(Math.random()*2**31);let h=2166136261>>>0;for(let i=0;i<seedStr.length;i++){h^=seedStr.charCodeAt(i);h+=(h<<1)+(h<<4)+(h<<7)+(h<<8)+(h<<24);}return h>>>0;}
    function computeWeights(players,biasFactor){return players.map(p=>Math.max(0,1+(biasFactor||0)*(p.civilianStreak||0)));}
    function weightedSampleWithoutReplacement(players,k,biasFactor,seedStr){
      if(k<=0)return[]; if(k>=players.length)return players.map(p=>p.uid);
      const weights=computeWeights(players,Math.max(0,biasFactor)); const selected=new Set(); const rng=mulberry32(normalizeSeed(seedStr));
      for(let pick=0;pick<k;pick++){let total=0;for(let i=0;i<players.length;i++){if(!selected.has(players[i].uid)) total+=weights[i];}
        let r=rng()*total; for(let i=0;i<players.length;i++){const p=players[i]; if(selected.has(p.uid))continue; if(r<weights[i]){selected.add(p.uid);break;} r-=weights[i];}}
      return Array.from(selected);
    }

    // Join/Create
    createBtn.addEventListener("click", async ()=>{
      myName = (nameInput.value||"").trim() || `Player-${uid.slice(0,5)}`;
      roomCode = makeCode();
      codeInput.value = roomCode;
      await set(ref(db, `rooms/${roomCode}`), {
        hostUid: uid,
        status: "lobby",
        settings: { mafiaCount: 1, biasFactor: 1, seed: "", round: 1 },
        game: { phase: "lobby", vote: null, lastEject: null },
        assignments: null,
        createdAt: Date.now()
      });
      await set(ref(db, `rooms/${roomCode}/players/${uid}`), {
        name: myName, joinedAt: Date.now(), civilianStreak: 0, alive: true
      });
      enterRoom();
    });

    joinBtn.addEventListener("click", async ()=>{
      myName = (nameInput.value||"").trim() || `Player-${uid.slice(0,5)}`;
      roomCode = (codeInput.value||"").trim().toUpperCase();
      if (!roomCode) return alert("Enter room code");
      await set(ref(db, `rooms/${roomCode}/players/${uid}`), {
        name: myName, joinedAt: Date.now(), civilianStreak: 0, alive: true
      });
      enterRoom();
    });

    function enterRoom(){
      roomTag.style.display = "inline-block";
      roomTag.textContent = `Room ${roomCode}`;
      subtitle.textContent = "In room • Dark mode";
      roleHidden = loadRoleHidden();
      if (unsubRoom) unsubRoom();
      unsubRoom = onValue(ref(db, `rooms/${roomCode}`), handleRoomSnap);
      switchScreen("screen-role"); // gameplay screen
    }

    // Host-only: Start Game (assign roles)
    startGameBtn.addEventListener("click", async ()=>{
      if (!roomCode) return;
      if (!isHost) { showToast("Only the host can start the game."); return; }
      await startGameAssignRoles();
    });

    async function startGameAssignRoles(){
      await runTransaction(ref(db, `rooms/${roomCode}`), (current)=>{
        if (!current) return current;
        if (current.assignments && current.game?.phase !== "lobby") return current; // already started
        const playersObj = current.players || {};
        const entries = Object.entries(playersObj).map(([id,p])=>({uid:id, name:p.name, civilianStreak:p.civilianStreak||0}));
        if (!entries.length) return current;
        // Reset alive
        for (const [id,p] of Object.entries(playersObj)) playersObj[id] = { ...p, alive: true };
        const settings = current.settings || { mafiaCount: 1, biasFactor: 1, seed: "", round: 1 };
        const maxMafia = Math.max(1, Math.floor(entries.length/2));
        const mCount = Math.max(1, Math.min(settings.mafiaCount||1, maxMafia));
        const mafia = weightedSampleWithoutReplacement(entries, mCount, settings.biasFactor||0, settings.seed||undefined);
        const mafiaMap = {}; mafia.forEach(id => mafiaMap[id]=true);
        // Update streaks
        for (const [id,p] of Object.entries(playersObj)) {
          playersObj[id] = { ...p, civilianStreak: mafiaMap[id] ? 0 : (p.civilianStreak||0)+1 };
        }
        current.players = playersObj;
        current.assignments = { round: settings.round || 1, createdAt: Date.now(), mafia: mafiaMap };
        current.settings = { ...settings, round: (settings.round||1)+1 };
        current.game = { phase: "roles", vote: null, lastEject: null };
        current.status = "assigned";
        return current;
      });
      showToast("Game started. Roles assigned.");
    }

    // Start meeting (host)
    startMeetingBtn.addEventListener("click", async ()=>{
      if (!roomSnap) return;
      if (!isHost) { showToast("Only the host can start a meeting."); return; }
      const playersObj = roomSnap.players || {};
      const alive = Object.entries(playersObj).filter(([id,p])=>p.alive!==false).map(([id])=>id);
      if (alive.length < 3) { showToast("Need at least 3 alive players"); return; }
      await runTransaction(ref(db, `rooms/${roomCode}`), (current)=>{
        if (!current) return current;
        const game = current.game || {};
        if (game.vote) return current; // already voting
        const playersObj2 = current.players || {};
        const alive2 = Object.entries(playersObj2).filter(([id,p])=>p.alive!==false).map(([id])=>id);
        game.phase = "voting";
        game.vote = {
          id: (game.voteSeq||0)+1,
          phase: "voting",
          candidates: mapKeysTrue(alive2),
          eligibleVoters: mapKeysTrue(alive2), // everyone alive votes, no skips
          votes: {},
          closed: false
        };
        game.voteSeq = (game.voteSeq||0)+1;
        current.game = game;
        return current;
      });
      showToast("Meeting started");
    });

    // Submit vote (FIX: use set() to write a primitive value)
    submitVoteBtn.addEventListener("click", async ()=>{
      if (!roomSnap?.game?.vote || !selectedVote) return;
      const vote = roomSnap.game.vote;
      if (!vote.eligibleVoters?.[uid]) { showToast("You are not eligible to vote now"); return; }
      if (!vote.candidates?.[selectedVote]) { showToast("Invalid candidate"); return; }
      await set(ref(db, `rooms/${roomCode}/game/vote/votes/${uid}`), selectedVote);
      submitVoteBtn.disabled = true;
      if (navigator.vibrate) navigator.vibrate(15);
      await maybeTallyVoteTransaction();
    });

    // Room updates
    async function handleRoomSnap(snap){
      const room = snap.val() || {};
      roomSnap = room;
      isHost = room?.hostUid === uid;

      // Host-only button visibility
      // Start Game visible for host when game is in lobby or no assignments yet.
      const inLobbyPhase = room.game?.phase === "lobby" || !room.assignments;
      startGameBtn.style.display = (isHost && inLobbyPhase) ? "inline-block" : "none";
      // Start Meeting visible only for host during roles phase
      startMeetingBtn.style.display = (isHost && room.game?.phase === "roles") ? "inline-block" : "none";

      // Counters
      const playersObj = room.players || {};
      const mafiaMap = room.assignments?.mafia || {};
      const alive = Object.entries(playersObj).filter(([id,p])=>p.alive!==false).length;
      const mafiaAlive = Object.entries(playersObj).filter(([id,p])=>p.alive!==false && mafiaMap[id]).length;
      aliveCounter.textContent = String(alive);
      mafiaCounter.textContent = String(mafiaAlive);
      roundNo.textContent = String(room.settings?.round || 1);

      // Role visibility and label
      const isMafia = !!mafiaMap[uid];
      myRoleIsMafia = room.assignments ? isMafia : null;
      renderRole();

      // Vote panel
      const vote = room.game?.vote || null;
      if (room.game?.phase === "voting" || room.game?.phase === "revote") {
        showVotePanel(vote, playersObj, room.game.phase);
        await maybeTallyVoteTransaction();
      } else {
        votePanel.style.display = "none";
      }

      // Ejection info
      if (room.game?.lastEject) {
        ejectPanel.style.display = "block";
        const ej = room.game.lastEject;
        ejectTitle.textContent = `${ej.name || ej.uid.slice(0,6)+"…"} was ejected`;
        ejectDetail.innerHTML = `Role revealed: <span class="roleBadge ${ej.role==='mafia'?'mafia':'civ'}">${ej.role==='mafia'?'Mafia':'Civilian'}</span>`;
      } else {
        ejectPanel.style.display = "none";
      }

      // Always stay on role screen during the game
      if (screenJoin.classList.contains("active")) switchScreen("screen-role");
    }

    // Vote panel render under role
    function showVotePanel(vote, playersObj, phase){
      votePanel.style.display = "block";
      votePhaseBadge.textContent = phase === "revote" ? "Re-vote" : "Voting";
      voteTitle.textContent = phase === "revote" ? "Tie! Re-vote" : "Meeting Vote";
      voteHint.textContent = phase === "revote" ? "Only tied players are options. Tied players cannot vote." : "Choose one player. No skips.";
      const isEligible = !!vote?.eligibleVoters?.[uid];
      selectedVote = vote?.votes?.[uid] || null;

      voteGrid.innerHTML = "";
      const playersEntries = Object.entries(playersObj).sort((a,b)=>(a[1].joinedAt||0)-(b[1].joinedAt||0));
      const candidates = new Set(Object.keys(vote?.candidates || {}));
      for (const [pid, p] of playersEntries) {
        if (!candidates.has(pid)) continue;
        const btn = document.createElement("button");
        btn.className = "voteBtn" + (selectedVote===pid ? " selected" : "");
        btn.innerHTML = `
          <div class="dot" style="background:${p.alive===false?'#334155':'#22d3ee'}"></div>
          <div class="grow">${escapeHtml(p.name || pid.slice(0,6)+"…")}</div>
        `;
        if (!isEligible) btn.classList.add("disabled");
        btn.addEventListener("click", ()=>{
          if (!isEligible) return;
          selectedVote = pid;
          submitVoteBtn.disabled = false;
          for (const el of voteGrid.querySelectorAll(".voteBtn")) el.classList.remove("selected");
          btn.classList.add("selected");
        });
        voteGrid.appendChild(btn);
      }

      const eligible = Object.keys(vote?.eligibleVoters || {});
      const cast = Object.keys(vote?.votes || {}).length;
      voteStatus.textContent = `Votes: ${cast}/${eligible.length}`;
      submitVoteBtn.disabled = !isEligible || !selectedVote;
    }

    // Tally logic on room root (handles revote and ejection)
    async function maybeTallyVoteTransaction(){
      if (!roomCode) return;
      await runTransaction(ref(db, `rooms/${roomCode}`), (current)=>{
        if (!current?.game?.vote || current.game.vote.closed) return current;
        const vote = current.game.vote;
        const playersObj = current.players || {};
        // Complete only when all eligible have voted
        const eligible = Object.keys(vote.eligibleVoters || {});
        const castCount = Object.keys(vote.votes || {}).length;
        if (castCount < eligible.length) return current;

        // Count votes
        const tally = {};
        for (const [voter, cand] of Object.entries(vote.votes || {})) {
          if (vote.candidates?.[cand]) tally[cand] = (tally[cand]||0)+1;
        }
        const pairs = Object.entries(tally);
        if (!pairs.length) {
          // No valid votes -> tie among all candidates
          const tiedAll = Object.keys(vote.candidates || {});
          return createRevote(current, tiedAll);
        }
        pairs.sort((a,b)=>b[1]-a[1]);
        const top = pairs[0][1];
        const tied = pairs.filter(([id,c])=>c===top).map(([id])=>id);

        if (tied.length === 1) {
          // Decide ejection
          const ejectUid = tied[0];
          const mafiaMap = current.assignments?.mafia || {};
          const role = mafiaMap[ejectUid] ? "mafia" : "civilian";
          const name = playersObj[ejectUid]?.name || ejectUid.slice(0,6)+"…";
          // Update alive, clear vote, show ejection, return to roles phase
          if (playersObj[ejectUid]) playersObj[ejectUid].alive = false;
          current.players = playersObj;
          current.game.lastEject = { uid: ejectUid, name, role, at: Date.now() };
          current.game.vote = null;
          current.game.phase = "roles";
          return current;
        } else {
          // Create revote among tied. Tied players cannot vote.
          return createRevote(current, tied);
        }
      });
      // Optional: win check
      await checkWinCondition();
    }

    function createRevote(current, tiedIds){
      const playersObj = current.players || {};
      const eligible = {};
      for (const [id, p] of Object.entries(playersObj)) {
        if (p.alive === false) continue;
        if (tiedIds.includes(id)) continue; // tied players can't vote in revote
        eligible[id] = true;
      }
      current.game.phase = "revote";
      current.game.vote = {
        id: (current.game.voteSeq||0)+1,
        phase: "revote",
        candidates: mapKeysTrue(tiedIds),
        eligibleVoters: eligible,
        votes: {},
        closed: false
      };
      current.game.voteSeq = (current.game.voteSeq||0)+1;
      return current;
    }

    async function checkWinCondition(){
      if (!roomCode) return;
      const room = (await get(ref(db, `rooms/${roomCode}`))).val();
      const players = Object.entries(room.players||{});
      const alive = players.filter(([id,p])=>p.alive!==false).map(([id])=>id);
      const mafiaAlive = alive.filter(id=> room.assignments?.mafia?.[id]).length;
      const civAlive = alive.length - mafiaAlive;
      let winner = null;
      if (mafiaAlive === 0) winner = "civilians";
      else if (mafiaAlive >= civAlive) winner = "mafia";
      if (winner) {
        await update(ref(db, `rooms/${roomCode}/game`), { phase: "gameover", winner });
        showToast(`Game over • ${winner.toUpperCase()} win`);
      }
    }

    // Role toggle
    toggleRoleBtn.addEventListener("click", ()=>{
      roleHidden = !roleHidden;
      saveRoleHidden(roleHidden);
      renderRole();
      if (navigator.vibrate) navigator.vibrate(10);
    });

    function renderRole(){
      if (myRoleIsMafia == null) {
        roleBadge.textContent = "Waiting for assignment…";
        roleBadge.className = "pill";
        roleBadge.style.display = roleHidden ? "none" : "inline-block";
        roleMasked.style.display = roleHidden ? "inline-block" : "none";
        toggleRoleBtn.disabled = true;
        toggleRoleBtn.textContent = "Hide Role";
      } else {
        const text = myRoleIsMafia ? "MAFIA" : "CIVILIAN";
        const cls = myRoleIsMafia ? "pill red" : "pill green";
        roleBadge.textContent = text;
        roleBadge.className = cls;
        roleBadge.style.display = roleHidden ? "none" : "inline-block";
        roleMasked.style.display = roleHidden ? "inline-block" : "none";
        roleMasked.textContent = "Hidden • Tap Show";
        toggleRoleBtn.disabled = false;
        toggleRoleBtn.textContent = roleHidden ? "Show Role" : "Hide Role";
      }
    }

    // Utils
    function byId(id){ return document.getElementById(id); }
    function showToast(msg, ms=2000){ toastEl.textContent = msg; toastEl.classList.add("show"); setTimeout(()=>toastEl.classList.remove("show"), ms); }
    function getOrMakeGuestId(){ const k="mafia-guest-uid"; let v=localStorage.getItem(k); if(!v){ v=(self.crypto?.randomUUID?.()||Math.random().toString(36).slice(2))+"-"+Date.now().toString(36); localStorage.setItem(k,v); } return v; }
    function makeCode(){ const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; let s=""; for (let i=0;i<6;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g,(m)=>({"&":"&amp;","<":"&lt;"," >":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }
    function mapKeysTrue(arr){ const o={}; for (const id of arr) o[id]=true; return o; }
    function loadRoleHidden(){ const k = `role-hidden-${roomCode}-${uid}`; const v = localStorage.getItem(k); return v === null ? true : v === "1"; }
    function saveRoleHidden(v){ const k = `role-hidden-${roomCode}-${uid}`; localStorage.setItem(k, v ? "1" : "0"); }

    function switchScreen(id){
      for (const el of [screenJoin, screenRole]) el.classList.remove("active");
      byId(id).classList.add("active");
    }
  </script>
</body>
</html>